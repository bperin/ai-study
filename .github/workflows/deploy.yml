name: Deploy

on:
    push:
        branches:
            - main
            - staging
    workflow_dispatch:

env:
    GCP_PROJECT_ID: pro-pulsar-274402
    GCP_REGION: us-central1
    API_SERVICE_NAME: ai-study-api
    WEB_SERVICE_NAME: ai-study-web
    NEXT_PUBLIC_API_URL: ${{ vars.NEXT_PUBLIC_API_URL }}

jobs:
    deploy:
        name: Deploy API and Web
        runs-on: ubuntu-latest
        permissions:
            contents: read
            id-token: write
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Authenticate to Google Cloud
              uses: google-github-actions/auth@v2
              with:
                  credentials_json: ${{ secrets.GCP_SA_KEY }}

            - name: Set up gcloud CLI
              uses: google-github-actions/setup-gcloud@v2
              with:
                  project_id: ${{ env.GCP_PROJECT_ID }}

            - name: Configure Docker for GCP
              run: gcloud auth configure-docker us-central1-docker.pkg.dev

            - name: Build and Push API Image
              run: |
                  docker build -f packages/api/Dockerfile \
                    -t us-central1-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/ai-study/api:latest .
                  docker push us-central1-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/ai-study/api:latest

            - name: Deploy API service
              id: deploy-api
              run: |
                  gcloud run deploy ${{ env.API_SERVICE_NAME }} \
                    --image us-central1-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/ai-study/api:latest \
                    --project ${{ env.GCP_PROJECT_ID }} \
                    --region ${{ env.GCP_REGION }} \
                    --port 8080 \
                    --timeout 600 \
                    --allow-unauthenticated \
                    --clear-env-vars \
                    --set-secrets=DATABASE_URL=DATABASE_URL:latest \
                    --set-secrets=GCP_SA_KEY=GCP_SA_KEY:latest \
                    --set-secrets=GCP_BUCKET_NAME=GCP_BUCKET_NAME:latest \
                    --quiet \
                    --format='value(status.url)' > api_url.txt
                  echo "API_URL=$(cat api_url.txt)" >> $GITHUB_ENV

            - name: Build and Push Web Image
              run: |
                  docker build -f packages/web/Dockerfile \
                    --build-arg NEXT_PUBLIC_API_URL="${{ env.API_URL }}" \
                    -t us-central1-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/ai-study/web:latest .
                  docker push us-central1-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/ai-study/web:latest

            - name: Deploy Web service
              id: deploy-web
              run: |
                  gcloud run deploy ${{ env.WEB_SERVICE_NAME }} \
                    --image us-central1-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/ai-study/web:latest \
                    --project ${{ env.GCP_PROJECT_ID }} \
                    --region ${{ env.GCP_REGION }} \
                    --set-env-vars NEXT_PUBLIC_API_URL=${{ env.API_URL }} \
                    --allow-unauthenticated \
                    --quiet \
                    --format='value(status.url)' > web_url.txt
                  echo "WEB_URL=$(cat web_url.txt)" >> $GITHUB_ENV

            - name: Update API CORS
              run: |
                  gcloud run services update ${{ env.API_SERVICE_NAME }} \
                    --region ${{ env.GCP_REGION }} \
                    --set-env-vars "FRONTEND_URL=${{ env.WEB_URL }}" \
                    --quiet
