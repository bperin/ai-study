name: Deploy

on:
    push:
        branches:
            - main
    workflow_dispatch:

env:
    GCP_PROJECT_ID: slap-ai-481400
    GCP_PROJECT_NUMBER: '578398115938'
    GCP_REGION: us-central1
    API_SERVICE_NAME: ai-study-api
    WEB_SERVICE_NAME: ai-study-web
    NEXT_PUBLIC_API_URL: ${{ vars.NEXT_PUBLIC_API_URL }}

jobs:
    deploy:
        name: Deploy API and Web
        runs-on: ubuntu-latest
        permissions:
            contents: read
            id-token: write
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Authenticate to Google Cloud
              id: auth
              uses: google-github-actions/auth@v2
              with:
                  token_format: 'access_token'
                  workload_identity_provider: projects/${{ env.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-deploy-pool/providers/github-provider
                  service_account: ai-study-uploader@${{ env.GCP_PROJECT_ID }}.iam.gserviceaccount.com
                  audience: //iam.googleapis.com/projects/${{ env.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-deploy-pool/providers/github-provider

            - name: Set up gcloud CLI
              uses: google-github-actions/setup-gcloud@v2
              with:
                  project_id: ${{ env.GCP_PROJECT_ID }}

            - name: Login to Artifact Registry
              uses: docker/login-action@v3
              with:
                  registry: us-central1-docker.pkg.dev
                  username: oauth2accesstoken
                  password: ${{ steps.auth.outputs.access_token }}

            - name: Get Database Connection String
              id: secrets
              uses: google-github-actions/get-secretmanager-secrets@v2
              with:
                  secrets: |-
                      DATABASE_URL:projects/${{ env.GCP_PROJECT_ID }}/secrets/ai_study_DATABASE_URL

            - name: Run Database Migrations
              run: |
                  cd packages/api
                  npm install
                  export DATABASE_URL="${{ steps.secrets.outputs.DATABASE_URL }}"
                  npx prisma db push --accept-data-loss
                  npx prisma generate

            - name: Build and Push API Image
              run: |
                  docker buildx build \
                    --platform linux/amd64 \
                    -f packages/api/Dockerfile \
                    -t us-central1-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/ai-study/api:latest . \
                    --push
            
            - name: Make GCS Bucket Public
              run: |
                  gsutil iam ch allUsers:objectViewer gs://slap-ai-public-storage

            - name: Deploy API service
              id: deploy-api
              run: |
                  gcloud run deploy ${{ env.API_SERVICE_NAME }} \
                    --image us-central1-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/ai-study/api:latest \
                    --project ${{ env.GCP_PROJECT_ID }} \
                    --region ${{ env.GCP_REGION }} \
                    --port 8080 \
                    --timeout 600 \
                    --allow-unauthenticated \
                    --no-cpu-throttling \
                    --service-account ai-study-uploader@${{ env.GCP_PROJECT_ID }}.iam.gserviceaccount.com \
                    --set-secrets=DATABASE_URL=ai_study_DATABASE_URL:latest \
                    --set-secrets=GOOGLE_API_KEY=ai_study_GOOGLE_API_KEY:latest \
                    --set-secrets=JWT_SECRET=ai_study_JWT_SECRET:latest \
                    --set-secrets=GCP_BUCKET_NAME=ai_study_GCP_BUCKET_NAME:latest \
                    --set-secrets=REDIS_HOST=ai_study_REDIS_HOST:latest \
                    --set-secrets=REDIS_PORT=ai_study_REDIS_PORT:latest \
                    --set-secrets=REDIS_PASSWORD=ai_study_REDIS_PASSWORD:latest \
                    --set-env-vars GOOGLE_CLOUD_PROJECT_ID=${{ env.GCP_PROJECT_ID }} \
                    --quiet \
                    --format='value(status.url)' > api_url.txt
                  echo "API_URL=$(cat api_url.txt)" >> $GITHUB_ENV
            - name: Build and Push Web Image
              run: |
                  docker buildx build \
                    --platform linux/amd64 \
                    -f packages/web/Dockerfile \
                    --build-arg NEXT_PUBLIC_API_URL="$API_URL" \
                    -t us-central1-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/ai-study/web:latest . \
                    --push
            - name: Set Permissive GCS CORS Policy
              run: |
                  echo '[
                    {
                      "origin": ["*"],
                      "method": ["*"],
                      "responseHeader": ["*"],
                      "maxAgeSeconds": 3600
                    }
                  ]' > permissive-cors.json
                  gsutil cors set permissive-cors.json gs://slap-ai-public-storage

            - name: Deploy Web service
              id: deploy-web
              run: |
                  gcloud run deploy ${{ env.WEB_SERVICE_NAME }} \
                    --image us-central1-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/ai-study/web:latest \
                    --project ${{ env.GCP_PROJECT_ID }} \
                    --region ${{ env.GCP_REGION }} \
                    --set-env-vars NEXT_PUBLIC_API_URL="$API_URL" \
                    --allow-unauthenticated \
                    --quiet \
                    --format='value(status.url)' > web_url.txt
                  echo "WEB_URL=$(cat web_url.txt)" >> $GITHUB_ENV
